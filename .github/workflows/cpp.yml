name: Check c++ pkg PROPOSAL.

on: [push]

jobs:

  dependencies:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Install python dependencies
      run: python -m pip install conan
    - name: Install PROPOSAL dependencies
      run:  conan install .
    - uses: actions/upload-artifact@master
      with:
        name: conan-deps
        path: /home/runner/.conan


  build:
    runs-on: ubuntu-latest
    needs: dependencies
    steps:
    - uses: actions/checkout@master
    - uses: actions/download-artifact@master
      with:
        name: conan-deps
        path: /home/runner/.conan
    - name: Install python dependencies
      run: python -m pip install conan
    - name: Create PROPOSAL package directory
      run: mkdir PROPOSAL_PKG
    - name: Install PROPOSAL dependencies
      run:  conan install .
    - name: Build automatisation
      run: cmake . -DCMAKE_INSTALL_PREFIX=PROPOSAL_PKG
    - name: Build lib
      run: make -j
    - name: Install lib
      run: make install
    - uses: actions/upload-artifact@master
      with:
        name: proposal-pkg
        path: $(pwd)/PROPOSAL_PKG


  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
     - uses: actions/checkout@master
     - uses: actions/download-artifact@master
       with:
         name: proposal-pkg
         path: $(pwd)/PROPOSAL_PKG
       with:
         name: conan-deps
         path: /home/runner/.conan
     - name: Build automatisation
       run: cmake . -DCMAKE_PREFIX_PATH=PROPOSAL_PKG --target=tests
     - name: Build lib
       run: make -j
     - name: Run tests
       run: make test
