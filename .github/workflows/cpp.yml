name: Check c++ pkg PROPOSAL.

on: [push]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Cache conan
      uses: actions/cache@v2
      with:
        path: ~/.conan
        key: ${{ runner.os }}-build-cache-conan
    - name: Install python dependencies
      run: python -m pip install conan
    - name: Create PROPOSAL package directory
      run: mkdir PROPOSAL_PKG
    - name: Create build dir and install PROPOSAL dependencies
      run: |
            mkdir PROPOSAL_BUILD
            cd PROPOSAL_BUILD
            rm -rf ~/.conan
            conan profile new default --detect
            conan profile update settings.compiler.libcxx=libstdc++11 default
            conan install ..
    - name: Run build automatisation tool
      run: cmake . -B PROPOSAL_BUILD
    - name: Build lib
      run: make -C PROPOSAL_BUILD -j
    - uses: actions/upload-artifact@master
      with:
        name: proposal-build
        path: PROPOSAL_BUILD


  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
     - uses: actions/checkout@master
     - name: Install gtest
       run: sudo apt-get install libgtest-dev
     - name: Cache conan
       uses: actions/cache@v2
       with:
         path: ~/.conan
         key: ${{ runner.os }}-build-cache-conan
     - uses: actions/download-artifact@master
       with:
         name: proposal-build
         path: PROPOSAL_BUILD
     - name: Rerun cmake
       run: cmake . -B PROPOSAL_BUILD -DBUILD_TESTING=True
     - name: Build lib
       run: make -C PROPOSAL_BUILD -j
     - name: Run tests
       run: make -C PROPOSAL_BUILD test
