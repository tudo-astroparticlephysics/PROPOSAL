name: Check c++ pkg PROPOSAL.

on: [push]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Cache conan
      uses: actions/cache@v2
      env:
        cache-name: cache-conan
      with:
        # npm cache files are stored in `~/.npm` on Linux/macOS
        path: ~/.conan
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/conanfile.py') }}
    - name: Install python dependencies
      run: python -m pip install conan
    - name: Create PROPOSAL package directory
      run: mkdir PROPOSAL_PKG
    - name: Install PROPOSAL dependencies
      run:  conan install .
    - name: Build automatisation
      run: cmake . -DCMAKE_INSTALL_PREFIX=PROPOSAL_PKG
    - name: Build lib
      run: make -j
    - name: Install lib
      run: make install
    - uses: actions/upload-artifact@master
      with:
        name: proposal-pkg
        path: $(pwd)/PROPOSAL_PKG


  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
     - uses: actions/checkout@master
     - uses: actions/download-artifact@master
       with:
         name: proposal-pkg
         path: $(pwd)/PROPOSAL_PKG
     - name: Build automatisation
       run: cmake . -DCMAKE_PREFIX_PATH=PROPOSAL_PKG --target=tests
     - name: Build lib
       run: make -j
     - name: Run tests
       run: make test
